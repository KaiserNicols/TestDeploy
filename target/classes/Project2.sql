-------------------------------------------------------------------------------
-- TABLES
-------------------------------------------------------------------------------
CREATE TABLE IMDB_USER
(
    U_ID NUMBER NOT NULL,
    U_USERNAME VARCHAR2(50) NOT NULL,
    U_PASSWORD VARCHAR2(50) NOT NULL,
    U_EMAIL VARCHAR2(50) NOT NULL,
    U_FIRSTNAME VARCHAR2(50) NOT NULL,
    U_LASTNAME VARCHAR2(50) NOT NULL,
    CONSTRAINT PK_U_ID PRIMARY KEY (U_ID),
    CONSTRAINT UNQ_U_USERNAME UNIQUE (U_USERNAME)
);

CREATE TABLE IMDB_RECOMMENDATION
(
    R_ID NUMBER NOT NULL,
    U_ID NUMBER NOT NULL,
    R_IDENTIFIER NUMBER NOT NULL,
    R_DATE VARCHAR2(50) NOT NULL,
    CONSTRAINT PK_R_ID PRIMARY KEY (R_ID),
    CONSTRAINT FK_U_ID FOREIGN KEY (U_ID) REFERENCES IMDB_USER(U_ID)
);

CREATE TABLE GAME
(
    G_ID NUMBER NOT NULL,
    G_NAME VARCHAR2(50) NOT NULL,
    G_TYPE VARCHAR2(50) NOT NULL,
    CONSTRAINT PK_G_ID PRIMARY KEY (G_ID),
    CONSTRAINT UNQ_G_NAME UNIQUE (G_NAME)
);

CREATE TABLE GAME_SESSION
(
    GS_ID NUMBER NOT NULL,
    P_ID NUMBER NOT NULL,
    G_ID NUMBER NOT NULL,
    GS_STATUS VARCHAR2(50) NOT NULL,
    GS_DATE VARCHAR2(50) NOT NULL,
    CONSTRAINT PK_GS_ID PRIMARY KEY (GS_ID),
    CONSTRAINT FK_P_ID FOREIGN KEY (P_ID) REFERENCES PLAYER(P_ID),
    CONSTRAINT FK_G_ID FOREIGN KEY (G_ID) REFERENCES GAME(G_ID)
);

SELECT * FROM IMDB_USER;
SELECT * FROM GAME;
SELECT * FROM GAME_SESSION;

INSERT INTO PLAYER VALUES(0, 'admin', 'admin', 'admin@admin.admin', 'admin', 'admin');
UPDATE PLAYER SET P_PASSWORD = 'CBB5650EFFC730AD4BFAE5CFD50E6340' WHERE P_ID = 0;
INSERT INTO GAME VALUES(0, 'TWENTY_QUESTIONS', 'TWENTY_QUESTIONS');
SELECT * FROM GAME_SESSION WHERE P_ID = 1 AND G_ID = 1 AND GS_Date = '';

EXEC DELETE_ALL_GAME_SESSION;
EXEC DELETE_ALL_PLAYER;
EXEC DELETE_ALL_GAME;

SELECT GET_EMPLOYEE_HASH('admin', 'admin') FROM dual;
commit;
-------------------------------------------------------------------------------
-- SEQUENCERS
-------------------------------------------------------------------------------

DROP SEQUENCE PLAYER_SEQ;

CREATE SEQUENCE USER_SEQ
    START WITH 1
    INCREMENT BY 1;
    
CREATE SEQUENCE GAME_SEQ
    START WITH 1
    INCREMENT BY 1;

CREATE SEQUENCE GAME_SESSION_SEQ
    START WITH 1
    INCREMENT BY 1;
    
-------------------------------------------------------------------------------
-- STORED PROCEDURES
-------------------------------------------------------------------------------

DROP FUNCTION GET_PLAYER_HASH;

-- YUVI's - HASHING FUNCTION THAT COMBINES USERNAME, PASSWORD AND A SPECIAL WORD
CREATE OR REPLACE FUNCTION GET_USER_HASH(USERNAME VARCHAR2, PASSWORD VARCHAR2) RETURN VARCHAR2
IS
EXTRA VARCHAR2(10) := 'SALT';
BEGIN
  RETURN TO_CHAR(DBMS_OBFUSCATION_TOOLKIT.MD5(
  INPUT => UTL_I18N.STRING_TO_RAW(DATA => USERNAME || PASSWORD || EXTRA)));
END;
/

CREATE OR REPLACE PROCEDURE DELETE_ALL_USER
AS
BEGIN
    DELETE FROM (SELECT * FROM IMDB_USER);
end;
/

CREATE OR REPLACE PROCEDURE DELETE_ALL_GAME
AS
BEGIN
    DELETE FROM (SELECT * FROM GAME);
end;
/

CREATE OR REPLACE PROCEDURE DELETE_ALL_GAME_SESSION
AS
BEGIN
    DELETE FROM (SELECT * FROM GAME_SESSION);
end;
/

-------------------------------------------------------------------------------
-- TRIGGERS
-------------------------------------------------------------------------------
    
DROP TRIGGER PLAYER_B_INSERT;
    
CREATE OR REPLACE TRIGGER USER_B_INSERT
BEFORE INSERT ON IMDB_USER FOR EACH ROW
BEGIN
  -- INCREASE THE SEQUENCE
  IF :NEW.U_ID IS NULL THEN
    SELECT USER_SEQ.NEXTVAL INTO :NEW.U_ID FROM DUAL;
  END IF;
END;
/

CREATE OR REPLACE TRIGGER GAME_B_INSERT
BEFORE INSERT ON GAME FOR EACH ROW
BEGIN
  -- INCREASE THE SEQUENCE
  IF :NEW.G_ID IS NULL THEN
    SELECT GAME_SEQ.NEXTVAL INTO :NEW.G_ID FROM DUAL;
  END IF;
END;
/
 
CREATE OR REPLACE TRIGGER GAME_SESSION_B_INSERT
BEFORE INSERT ON GAME_SESSION FOR EACH ROW
BEGIN
  -- INCREASE THE SEQUENCE
  IF :NEW.GS_ID IS NULL THEN
    SELECT GAME_SESSION_SEQ.NEXTVAL INTO :NEW.GS_ID FROM DUAL;
  END IF;
END;
/
 
-------------------------------------------------------------------------------
-- SYNONYMS
-------------------------------------------------------------------------------

CREATE OR REPLACE PUBLIC SYNONYM IMDB_USER FOR admin.IMDB_USER;
CREATE OR REPLACE PUBLIC SYNONYM GAME FOR admin.GAME;
CREATE OR REPLACE PUBLIC SYNONYM GAME_SESSION FOR admin.GAME_SESSION;
CREATE OR REPLACE PUBLIC SYNONYM USER_SEQ FOR admin.USER_SEQ;
CREATE OR REPLACE PUBLIC SYNONYM GAME_SEQ FOR admin.GAME_SEQ;
CREATE OR REPLACE PUBLIC SYNONYM GAME_SESSION_SEQ FOR admin.GAME_SESSION_SEQ;
CREATE OR REPLACE PUBLIC SYNONYM DELETE_ALL_USER FOR admin.DELETE_ALL_USER;
CREATE OR REPLACE PUBLIC SYNONYM DELETE_ALL_GAME FOR admin.DELETE_ALL_GAME;
CREATE OR REPLACE PUBLIC SYNONYM DELETE_ALL_GAME_SESSION FOR admin.DELETE_ALL_GAME_SESSION;
CREATE OR REPLACE PUBLIC SYNONYM USER_B_INSERT FOR admin.USER_B_INSERT;
CREATE OR REPLACE PUBLIC SYNONYM GAME_B_INSERT FOR admin.GAME_B_INSERT;
CREATE OR REPLACE PUBLIC SYNONYM GAME_SESSION_B_INSERT FOR admin.GAME_SESSION_B_INSERT;